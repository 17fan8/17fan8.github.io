<!doctype>
<html>

<head>
    <link href="libs/bootstrap-4.0.0-dist/css/bootstrap.css" rel="stylesheet">
    <link href="libs/bootstrap-slider/css/bootstrap-slider.min.css" rel="stylesheet">
    <link href="stylesheets/style.css" rel="stylesheet">
    <link href="stylesheets/ui-block.css" rel="stylesheet">
    <link href="stylesheets/base.css" rel="stylesheet">
    <title>一起吃饭吧！</title>
    <meta name=viewport content="width=device-width">
    <meta charset="utf-8">
</head>
<body>
    <div class=logo-main></div>
    <div class="title" style="text-align: center;"></div>
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div id="bind-addr-box" class="alert text-nowrap">
                    <span>当前绑定地址：</span>
                    <span id="bind-addr"></span>                
                    <!--a style="float:right;" onclick="onClearBindAddr()">清空</a-->
                    <a style="float:right;" data-toggle="modal" data-target="#bind-addr-dialog">修改</a>
                </div>
            </div>
            <div class="col">
                <div style="background-color:lightblue;border:2px dashed;border-radius: 4px;color: darkslategray;padding:1em;font-size: 2pm;">
                    <span data-i18n="rules"></span>
                </div>
            </div>
        </div>
    </div>
    <div id=result class="container" >
    </div>

    <div class=footer></div>

    <!-- 竞投对话框 -->
    <div class="modal fade" id="bid-dialog">
        <div class="modal-dialog">
            <div class="modal-content">

                <!-- 模态框头部 -->
                <div class="modal-header">
                    <h4 id="dlg-title" class="modal-title">竞价</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>

                <!-- 模态框主体 -->
                <div class="modal-body">
                    <div class="container" >
                        <div class="row from-group" style="display:none;">
                            <div class="col-md-12">
                                <label for="dlg-email">EMail：</label>
                                <input id="dlg-email" class="form-control">
                            </div>
                            <div class="col-md-12">
                                <label for="dlg-email-repeat">确认EMail：</label>
                                <input id="dlg-email-repeat" class="form-control">
                            </div>
                        </div>
                        <div class=row>
                            <div class="col-md-6">
                                <label for="dlg-number">出价：</label>
                            </div>
                            <div class="col-md-6" style="text-align: right;">
                                <label id="dlg-bid-nas"></label>                                
                            </div>
                            <div class="w-100"></div>
                            <div class="col">
                                <input id="dlg-number" style="width:100%;" data-slider-id="ex1Slider" type="text"/>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 模态框底部 -->
                <div class="modal-footer form-group">
                    <div class="container" >
                        <div class=row>
                            <div class="col-md-6">
                                <button type="button" class="btn btn-block btn-mutil-line" data-dismiss="modal">取消</button>
                            </div>
                            <div class="col-md-6">
                                <button id="bid-ok" type="button" class="btn btn-block btn-mutil-line" onclick="onBid()">确定</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 绑定钱包地址对话框 -->
    <div class="modal fade" id="bind-addr-dialog">
        <div class="modal-dialog">
            <div class="modal-content">

                <!-- 模态框头部 -->
                <div class="modal-header">
                    <h4 id="bind-addr-title" class="modal-title">绑定钱包</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>

                <!-- 模态框主体 -->
                <div class="modal-body">
                    <div class="container" >
                        <div class="row from-group">
                            <div class="col-md-12">
                                <label for="bind-addr-addr">钱包地址（请用该钱包参与活动）：</label>
                                <div class="icon-address" placeholder="输入要绑定的钱包地址"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 模态框底部 -->
                <div class="modal-footer form-group">
                    <div class="container" >
                        <div class=row>
                            <div class="col-md-4 offset-md-2">
                                <button type="button" class="btn btn-block btn-mutil-line" data-dismiss="modal">取消</button>
                            </div>
                            <div class="col-md-4">
                                <button id="bind-addr-ok" type="button" class="btn btn-block btn-mutil-line" onclick="onBindAddr()">绑定</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="weixin-tip">
        <div class="modal-dialog">
            <div class="modal-content">
                <div style="text-align:center; padding:1.5em;">
                    <div style="color: saddlebrown;margin:2em 1em;" >请点击右上角的“...”，选择在浏览器打开</div>
                    <img style="border-radius:0.8em;width: 64%;" src="images/weixin-tip.jpeg" >
                </div>
            </div>
        </div>
    </div>

    <script src="libs/jquery-3.3.1.min.js"></script>
    <script src="libs/bootstrap-4.0.0-dist/js/bootstrap.bundle.min.js" data-depends="jquery.slim"></script>
    <script src="libs/bootstrap-slider/bootstrap-slider.min.js"></script>
    <script src="libs/external/jquery.md5.js"></script>
    <script src="libs/bootbox.min.js" data-depends="bootstrap jquery.slim"></script>
    <script src="libs/jquery.qrcode.min.js" data-depends="jquery"></script>
    <script src="libs/blockies.min.js"></script>
    <script src="dist/nebulas.js"></script>
    <script src="libs/nebPay.js"></script>
    <script src="js/1-localSave.js"></script>
    <script src="js/home.v1.js"></script>
    <script src="js/i18n.js" data-depends="jquery.slim"></script>
    <script src="js/ui-block.js" data-depends="bootbox blockies jquery.slim i18n.js nebulas.js"></script>
    <script>
        "use strict";
        var nebulas = require("nebulas"),
            Transaction = nebulas.Transaction,
            Utils = nebulas.Utils,
            Unit = nebulas.Unit,
            neb = new nebulas.Neb(),
            validateAll = uiBlock.validate();

        var queryNet = getQueryVariable("net");

        uiBlock.insert({
            footer: ".footer",
            title: ".title",
            header: ".header",
            iconAddress: ".icon-address",
            logoMain: [".logo-main", queryNet, queryNet==null],
            numberComma: ".number-comma",
        });

        var lang = localSave.getItem("lang");
        if((!os.isAndroid && !os.isPhone) && typeof (webExtensionWallet) === "undefined") {
            bootbox.dialog({
                backdrop: true,
                onEscape: true,
                message: lang=='zh'?"需要安装 extensionWallet 插件！":"Need install extensionWallet plugin!",
                size: "large",
                title: "Error"
            });
        }

        neb.setRequest(new nebulas.HttpRequest(localSave.getItem("apiPrefix")));

        var NebPay = require("nebpay");
        var nebPay = new NebPay();

        if(isWeixin()) {
            $("#weixin-tip").modal("show");
        }
        else {
            var bindAddr=localStorage.getItem("bindAddr");
            if(!bindAddr||bindAddr=="") {
                $("#bind-addr-dialog").modal("show");
                $("#bind-addr").text("未绑定");
                $("#bind-addr-box").addClass("alert-warning")
            }
            else {
                $("#bind-addr").text(bindAddr);
                $("#bind-addr-box").addClass("alert-success")
            }
        }
        
        var currentBlock = 0;
        neb.api.getNebState().then(function(state) {
            currentBlock = parseInt(state.height);
            listByIssuer("n1K2nSbJWiKVnHCAi7PFEjGef7iDQVFsTs8");
        });

        //计算可领取的NAS
        function getShareNas(dinner) {
            var sharedNas = Utils.toBigNumber(0);
            var tookNas = Utils.toBigNumber(0);
            if(bindAddr&&bindAddr!="") {
                var topBidNas = Utils.toBigNumber(0);
                var bidders = dinner.bidders;
                if(bidders.length>0) {
                    var topBidder = bidders[bidders.length-1];
                    topBidNas = topBidder.nas;
                }

                var sharedUnit = topBidNas.times(dinner.sharePercent).div(100*dinner.bidders.length);
                for(var i=0;i<bidders.length;++i) {
                    var bidder = bidders[i];
                    if(bidder.addr==bindAddr) {
                        if(!bidder.nasTook)
                            sharedNas = sharedNas.plus(sharedUnit);
                        else
                            tookNas = tookNas.plus(sharedUnit);
                    }
                }
            }
            return {sharedNas:sharedNas,tookNas:tookNas};
        }
        
        var dinners={};
        function addDinner(result,dinner) {
            var progressValue =0;
            if(dinner.endBlock>dinner.beginBlock) {
                progressValue= ((currentBlock-dinner.beginBlock)*100/(dinner.endBlock-dinner.beginBlock)).toFixed(2);
                if(progressValue<0)
                    progressValue=0;
                if(progressValue>100)
                    progressValue=100;
            }
            var topBidNas = Utils.toBigNumber(0), topBidderAddr="空缺";
            if(dinner.bidders.length>0) {
                var topBidder = dinner.bidders[dinner.bidders.length-1];
                topBidNas = topBidder.nas;
                topBidderAddr = topBidder.addr;
            }
            var decimal = getValueDecimal(dinner.minBidStep);
            var sharePercent = parseFloat(dinner.sharePercent||"0");

            const badges = '<span class="badge badge-info badge-pill">预计</span>';
            var stateText,progressClass,btnText,btnState,btnClick,startTime,endTime;
            if(dinner.beginBlock>currentBlock) {
                stateText = '<h6 style="text-align:center;">未开始('+currentBlock+')</h6>';
                progressClass='class="progress-bar progress-bar-striped bg-info"';
                btnText = "我要竞价";
                btnState = ' disabled=disabled';
                btnClick = '';
                startTime = formatTime(Date.now()+(dinner.beginBlock-currentBlock)*15)+badges
                endTime = formatTime(Date.now()+(dinner.beginBlock-currentBlock)*15)+badges;
            }
            else if(dinner.endBlock>currentBlock){
                stateText = '<h6 style="text-align:center;">进行中('+currentBlock+')</h6>';
                progressClass='class="progress-bar progress-bar-striped progress-bar-animated bg-info"';
                btnText = "我要竞价";
                btnState = '';
                btnClick = ' onclick="showBidDialog(this)"';
                startTime = "";
                endTime = formatTime(Date.now()+(dinner.endBlock-currentBlock)*15)+badges;
                queryBlockTime(result, ".begin-time", dinner.beginBlock);
            }
            else {
                var takeNas = getShareNas(dinner);
                stateText = '<h6 style="text-align:center;">已完成('+currentBlock+')</h6>';
                progressClass='class="progress-bar bg-info"';
                btnText = takeNas.tookNas.gt(0)?"已领取 "+takeNas.tookNas+" NAS":
                    (takeNas.sharedNas.gt(0)? "可领取 "+takeNas.sharedNas+" NAS":"可领取 0 NAS");
                btnState = takeNas.sharedNas.eq(0)?' disabled=disabled':'';
                btnClick = ' onclick="onTakeNas(this)"';
                startTime = "";
                endTime = "";
                queryBlockTime(result, ".begin-time", dinner.beginBlock);
                queryBlockTime(result, ".end-time", dinner.endBlock);
            }
                
            var html =
                '<div class="dinner" data-hash="' + dinner.hash + '">' +
                    '<div class="form-group row">' +
                        '<div class=col>' +
                            '<h4>'+dinner.title+'</h4>' +
                        '</div>' +
                        '<div class="w-100"></div>' +
                        '<div class="col text-nowrap">' +
                            '<i style="color:#aaa;">hash:"'+ dinner.hash +'"</i><hr>' +
                        '</div>' +
                    '</div>' +
                    '<div class="form-group row">' +
                        '<div class=col>' +
                            dinner.text +
                        '</div>'+
                    '</div> <hr>'+
                    '<div class=row>' +
                        '<div class=col>' +
                            stateText +
                            '<div class="progress">' +
                                '<div ' + progressClass + ' role="progressbar" ' +
                                    'value='+currentBlock+' min=' + dinner.beginBlock + 
                                    ' aria-valuemax=' + dinner.beginBlock + ' style="width:'+progressValue+'%;">'+
                                '<span>'+progressValue+'%</span>'+
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="row">' +
                        '<div class="col-md-12">' +
                            '<span style="float:left;">' + dinner.beginBlock+'</span>' +
                            '<span style="float:right;">' + dinner.endBlock+'</span>' +
                        '</div>' +
                    '</div> <hr>' +
                    '<div class="row">' +
                        '<div class="col-md-6 text-nowrap">' +
                            '开始时间：<span class="begin-time">'+startTime+'</span>' +
                        '</div>' +
                        '<div class="col-md-6 text-nowrap">' +
                            '结束时间：<span class="end-time">'+endTime+'</span>' +
                        '</div>' +
                        '<div class="col-md-6 text-nowrap">' + 
                            '最高竞价：'+ topBidNas.toFixed(decimal) + ' NAS' +
                        '</div>' +
                        '<div class="col-md-6 text-nowrap">' + 
                            '最高竞家：' + topBidderAddr +
                        '</div>' +
                        '<div class="col-md-6">' + 
                            '竞价次数：'+ dinner.bidders.length + '次' +
                        '</div>' +
                        '<div class=col-md-6>' +
                            '分成比例：'+ (dinner.sharePercent||0)+' %' +
                        '</div>' +
                    '</div>' +
                    '<hr>' +
                    '<div class="row form-group">'+
                        '<div class=col>' +
                            '<button class="btn btn-block" '+btnState+btnClick+'">'+btnText+'</button>' +
                        '</div>' +
                    '</div>'+
                '</div>';
            result.append(html);
        }

        function queryBlockTime(result,spanClassName,height) {
            neb.api.getBlockByHeight({height:height,fullTransaction:false}).then(function(block) {
                result.find(spanClassName).text(formatTime(block.timestamp*1000));
            });
        }

        function getNextInfo(result,param,ids,pos) {
            --pos;
            if(pos>=0) {
                getInfo(result,param,ids,pos);
            }
            else{
                var firstItem = result.children(".dinner").first();
                var pageWidth = firstItem.children().first().outerWidth();
                if(result.width()<pageWidth) {
                    var offset = result.outerWidth(true)-firstItem.width();
                    result.css({"transform":"scale("+result.outerWidth(true)/(pageWidth+offset)+")",
                    "transformOrigin":"left top"});
                }
            }
        }

        function getInfo(result,param,ids,pos) {
            var hash = ids[pos];
            var dinner = dinners[hash];
            if (!!dinner) {
                addDinner(result,dinner);
                getNextInfo(result,param,ids,pos);
                return;
            }
            param.contract={"function":"info","args":JSON.stringify([hash])};
            neb.api.call(param)
            .then(function(tx) {
                dinner = JSON.parse(tx.result);
                if(!!dinner && !!dinner.hash) {
                    var bidders = dinner.bidders;
                    dinner.minBidStep=dinner.minBidStep||0.1;
                    dinner.maxBidStep=dinner.maxBidStep||5;
                    for(var i=0;i<bidders.length;++i) {
                        var bidder = bidders[i];
                        bidder.nasInWei = Utils.toBigNumber(bidder.nasInWei);
                        bidder.nas = Unit.fromBasic(bidder.nasInWei,"nas");
                    }
                    dinners[dinner.hash] = dinner;
                    addDinner(result,dinner);
                    getNextInfo(result,param,ids,pos);
                }
                else {
                    console.log("parse dinner data fails.");
                }
            });
        }

        function listByIssuer(isseuerAddr) {
            var toAddress, contract;
            toAddress = localSave.getItem("contract");;
            contract={"function":"listByIssuer","args":JSON.stringify([isseuerAddr])}
        
            try {
                var temp = 
                {
                    from: isseuerAddr,
                    to: toAddress,
                    value: Unit.nasToBasic(Utils.toBigNumber("0")),
                    nonce: 0,
                    gasPrice: 1000000,
                    gasLimit: 200000,
                    contract: contract
                };
                var result = $("#result");
                result.html("");
                neb.api.call(temp).then(function(tx) {
                    if(!tx||!tx.result){
                        result.html("query fails.");
                        $("#queryByIssuer").removeAttr("disabled");                                                                
                        return;                                        
                    }
                    
                    var txResult = JSON.parse(tx.result);
                    if(!txResult || !txResult.ids || txResult.ids.length===0) {
                        result.html("no data.");
                        $("#queryByIssuer").removeAttr("disabled");                                                                
                    }
                    else {
                        getInfo(result,temp,txResult.ids,txResult.ids.length-1);
                    }
                });
            } catch (e) {
                $("#queryByIssuer").removeAttr("disabled");                            
                bootbox.dialog({
                    backdrop: true,
                    onEscape: true,
                    message: e,
                    size: "large",
                    title: "Error"
                });
            }
        }
        function onBid() {
            var hash, toAddress, email, amount, args;
            toAddress = localSave.getItem("contract");                
            email = $("#dlg-email").val();
            amount = $("#dlg-number").val();
            hash = $("#bid-dialog").attr("data-hash");
            args=[hash,email];

            $("#bid-ok").attr("disabled", "disabled");
            try {
                var serialNumber = nebPay.call(toAddress,amount,"bid",JSON.stringify(args),{
                    qrcode: {
                        showQRCode: false
                    },
                    goods: {
                        name: "bid"
                    },
                    callback: localSave.getItem("callback"),
                    listener: listener  //set listener for extension transaction result
                });

                $("#bid-ok").removeAttr("disabled");
                $("#bid-dialog").modal('toggle');
            } catch (e) {
                $("#bid-ok").removeAttr("disabled");
                bootbox.dialog({
                    backdrop: true,
                    onEscape: true,
                    message: e,
                    size: "large",
                    title: "Error"
                });
            }

            var intervalQuery = setInterval(function () {
                funcIntervalQuery();
            }, 10000);

            function funcIntervalQuery() {
                var options = {
                    callback: localSave.getItem("callback")
                }
                nebPay.queryPayInfo(serialNumber,options)   //search transaction result from server (result upload to server by app)
                .then(function (resp) {
                    console.log("tx result: " + resp)   //resp is a JSON string
                    var respObject = JSON.parse(resp)
                    if(respObject.code === 0){
                        clearInterval(intervalQuery);
                    }
                    //todo reflash dinner
                })
                .catch(function (err) {
                    console.log(err);
                });
            }

            function listener(resp) {
                console.log("resp: " + JSON.stringify(resp))
            }
        }

        function onTakeNas(btn) {
            var hash, toAddress, amount, args;
            hash = $(btn).closest(".dinner").attr("data-hash");
            toAddress = localSave.getItem("contract");
            amount = "0";
            args=[hash];
            try {
                var dinner = dinners[hash];
                for(var i=0;i<dinner.bidders.length;++i) {
                    if(dinner.bidders[i].addr == bindAddr)
                        dinner.bidders[i].tookNas=true;
                }
                $(btn).attr("disabled","disabled");
                var btnText = $(btn).text();
                $(btn).text(btnText.replace("可","已"));

                var serialNumber = nebPay.call(toAddress,amount,"takeNasByBidder",JSON.stringify(args),{
                    qrcode: {
                        showQRCode: false
                    },
                    goods: {
                        name: "takeNasByBidder"
                    },
                    callback: localSave.getItem("callback"),
                    listener: function(resp){
                        console.log("resp: " + JSON.stringify(resp))
                    }  //set listener for extension transaction result
                });
                var intervalQuery = setInterval(function () {
                    funcIntervalQuery();
                }, 10000);

                function funcIntervalQuery() {
                    var options = {
                        callback: localSave.getItem("callback")
                    }
                    nebPay.queryPayInfo(serialNumber,options)   //search transaction result from server (result upload to server by app)
                    .then(function (resp) {
                        console.log("tx result: " + resp)   //resp is a JSON string
                        var respObject = JSON.parse(resp)
                        if(respObject.code === 0){
                            clearInterval(intervalQuery);
                        }
                    })
                    .catch(function (err) {
                        console.log(err);
                    });
                }
            } catch (e) {
                bootbox.dialog({
                    backdrop: true,
                    onEscape: true,
                    message: e,
                    size: "large",
                    title: "Error"
                });
            }
        }

        function showBidDialog(btn){
            var hash = $(btn).closest(".dinner").attr("data-hash");
            var dinner = dinners[hash];
            if(!!dinner) {
                $("#dlg-title").text("竞价 - "+dinner.title);
                var topBidNas = Utils.toBigNumber(0);
                if(dinner.bidders.length>0) {
                    var topBidder = dinner.bidders[dinner.bidders.length-1];
                    topBidNas = topBidder.nas;
                }
                var decimal = getValueDecimal(dinner.minBidStep);
                
                var dlgNumber = $("#dlg-number");

                if(dlgNumber[0].slide)
                    dlgNumber.slider('destroy');

                $("#dlg-bid-nas").text(topBidNas.plus(1).toFixed(decimal) +" NAS");
                dlgNumber.val(topBidNas.toFixed(decimal));
                dlgNumber.attr({
                    "data-slider-step":dinner.minBidStep,
                    "data-slider-min":topBidNas.plus(dinner.minBidStep),
                    "data-slider-max":topBidNas.plus(dinner.maxBidStep),
                    "data-slider-value":topBidNas.plus(1)
                });
                $("#bid-dialog").attr("data-hash",hash);
                $("#bid-dialog").modal('show');

                dlgNumber.slider({
                    formatter: function(value) {
                        return value+' NAS';
                    }
                });
                dlgNumber.on("slide", function(slideEvt) {
                    $("#dlg-bid-nas").text(slideEvt.value+" NAS");
                });
                dlgNumber[0].slide=true;
            }
        }

        function onBindAddr() {
            var validateAll = uiBlock.validate("#bind-addr-dialog");
            if (validateAll()) {
                bindAddr = $("#bind-addr-dialog .icon-address input").val();
                localStorage.setItem("bindAddr",bindAddr);
                $("#bind-addr").text(bindAddr);
                $("#bind-addr-box").removeClass("alert-warning");
                $("#bind-addr-box").addClass("alert-success");
                $("#bind-addr-dialog").modal("toggle");
            }
        }
        function onClearBindAddr() {
            bindAddr="";
            localStorage.setItem("bindAddr",bindAddr);
            $("#bind-addr").text(bindAddr);
            $("#bind-addr-box").removeClass("alert-success");
            $("#bind-addr-box").addClass("alert-warning");
        }
    </script>
</body>
</html>